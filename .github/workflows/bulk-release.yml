name: Bulk Create Module Releases

on:
  push:
    branches:
      - v0.0.0-dev
      #- '*v*.*.*'
      #- main
  # workflow_dispatch:

permissions:
  contents: write

jobs:
  bulk-release-modules:
    name: Find and Release All Modules
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository with full history
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@6edd4406fa81c3da01a34fa6f6343087c207a568 # v3
        with:
          go-version: '1.25'

      - name: Find Modules, Check Tags, and Create Releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          echo "Searching for Go modules..."
          for modfile in $(find . -name go.mod); do
            MODULE_PATH=$(dirname "$modfile")
            MODULE_PATH=${MODULE_PATH#./}

            echo "---"
            echo "Processing module at path: $MODULE_PATH"

            # Find the latest version tag for this specific module path
            LATEST_TAG=$(git tag -l "$MODULE_PATH/v*" | sort -V | tail -n 1)

            if [ -z "$LATEST_TAG" ]; then
              echo "No version tags found for module '$MODULE_PATH'. Skipping."
              continue
            fi

            echo "Found latest tag: $LATEST_TAG"

            # Check if a release for this tag already exists
            if gh release view "$LATEST_TAG" >/dev/null 2>&1; then
              echo "Release for tag '$LATEST_TAG' already exists. Skipping."
              continue
            fi

            #echo "Release for '$LATEST_TAG' does not exist. Creating one now..."

            # Extract the version and module name
            MODULE_VERSION=${LATEST_TAG#$MODULE_PATH/}
            MODULE_NAME=$(basename "$MODULE_PATH")
            
            # Build the module binary
            echo "Building $MODULE_NAME..."
            (cd "./$MODULE_PATH" && go build -o "../../${MODULE_NAME}-${MODULE_VERSION}")

            # Create release
            echo "Creating GitHub release for $LATEST_TAG..."
            gh release create "$LATEST_TAG" \
              --title "$MODULE_NAME $MODULE_VERSION" \
              --notes "Release for module at path **$MODULE_PATH**." \
              --generate-notes \
              "./${MODULE_NAME}"
            
            echo "Successfully created release for $LATEST_TAG."
          done
          echo "---"
          echo "All modules processed."
