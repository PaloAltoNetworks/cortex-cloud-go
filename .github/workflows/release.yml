name: Create Module Release

on:
  #push:
  #  branches:
  #    - v0.0.0-dev
  #    #- '*/*v*.*.*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release-module:
    name: Release Go Module
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3

      - name: Set up Go
        uses: actions/setup-go@6edd4406fa81c3da01a34fa6f6343087c207a568 # v3
        with:
          go-version: '1.25'

      - name: Parse and Validate Module Path
        id: parse_tag
        run: |
          TAG=${{ github.ref_name }}
          # Use parameter expansion to get the path before the last '/' (the version)
          MODULE_PATH=${TAG%/*}
          MODULE_VERSION=${TAG#*/}
          
          # ❗️ Key Step: Validate that a go.mod file exists at the parsed path
          if [ ! -f "${MODULE_PATH}/go.mod" ]; then
            echo "Error: A go.mod file was not found in the path '${MODULE_PATH}' derived from the tag '${TAG}'."
            exit 1
          fi

          echo "Validation successful: Found go.mod in '${MODULE_PATH}'."

          # Get the module's simple name (e.g., 'api' from 'services/api') for the binary artifact
          MODULE_NAME=$(basename "${MODULE_PATH}")

          # Set environment variables for subsequent steps
          echo "TAG_NAME=${TAG}" >> $GITHUB_ENV
          echo "MODULE_PATH=${MODULE_PATH}" >> $GITHUB_ENV
          echo "MODULE_VERSION=${MODULE_VERSION}" >> $GITHUB_ENV
          echo "MODULE_NAME=${MODULE_NAME}" >> $GITHUB_ENV

      - name: Build the module binary
        run: |
          echo "Building module at path: ${{ env.MODULE_PATH }}"
          cd ./${{ env.MODULE_PATH }}
          go build -o ../${{ env.MODULE_NAME }}-${{ env.MODULE_VERSION }}

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ env.TAG_NAME }} \
            --title "${{ env.MODULE_NAME }} ${{ env.MODULE_VERSION }}" \
            --notes "Release for module at path **${{ env.MODULE_PATH }}**." \
            --generate-notes \
            ../${{ env.MODULE_NAME }}-${{ env.MODULE_VERSION }}
