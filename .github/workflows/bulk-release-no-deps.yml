name: Bulk Create No-Dependency Module Releases

on:
  workflow_dispatch:
    inputs:
      pre_release:
        description: 'Create as pre-release?'
        required: true
        type: boolean
        default: true
  #push:
  #  branches:
  #    - 'v0.0.0-dev'

permissions:
  contents: write

jobs:
  release:
    name: Find and Release No-Dependency Modules
    runs-on: ubuntu-latest
    outputs:
      created_tags: ${{ steps.release_step.outputs.created_tags }}
    steps:
      - name: Checkout repository with full history
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6
        with:
          go-version: '1.25'

      - name: Find Tags and Create Releases for No-Dep Modules
        id: release_step # Give the step an ID to access its outputs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e # Exit immediately if a command fails
          
          # This variable will store a space-separated list of tags we successfully create
          CREATED_TAGS=""

          # List of modules with no internal dependencies
          NO_DEP_MODULES="enums errors log types"

          echo "Processing modules with no internal dependencies..."
          for MODULE_PATH in $NO_DEP_MODULES; do
            echo "---"
            echo "Processing module at path: $MODULE_PATH"

            LATEST_TAG=$(git tag -l "$MODULE_PATH/v*" | sort -V | tail -n 1)

            if [ -z "$LATEST_TAG" ]; then
              echo "No version tags found for module '$MODULE_PATH'. Skipping."
              continue
            fi
            echo "Found latest tag: $LATEST_TAG"

            if gh release view "$LATEST_TAG" >/dev/null 2>&1; then
              echo "âœ… Release for tag '$LATEST_TAG' already exists. Skipping."
              continue
            fi
            echo "â—ï¸ Release for '$LATEST_TAG' does not exist. Creating one now..."

            MODULE_VERSION=${LATEST_TAG#$MODULE_PATH/}
            MODULE_NAME=$(basename "$MODULE_PATH")

            # Determine if this is a pre-release
            PRE_RELEASE_FLAG=""
            if [[ "${{ github.event.inputs.pre_release }}" == "true" ]]; then
              PRE_RELEASE_FLAG="--prerelease"
              echo "Marking release as a pre-release."
            fi

            echo "Creating GitHub release for $LATEST_TAG..."
            gh release create "$LATEST_TAG" \
              --title "$MODULE_NAME $MODULE_VERSION" \
              --notes "Automated release for module **$MODULE_PATH**." \
              --generate-notes \
              $PRE_RELEASE_FLAG
            
            echo "Successfully created release for $LATEST_TAG."
            
            # Add the successfully created tag to our list for potential rollback
            CREATED_TAGS="$CREATED_TAGS $LATEST_TAG"
          done
          echo "---"
          # Set the final list of created tags as an output for the next step
          echo "created_tags=$CREATED_TAGS" >> $GITHUB_OUTPUT
          echo "All modules processed successfully."

  # This job only runs if the release job fails
  rollback_on_failure:
    name: Rollback Releases on Failure
    if: failure() && needs.release.outputs.created_tags != ''
    runs-on: ubuntu-latest
    needs: release
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Delete created releases
        run: |
          echo "ðŸš¨ A failure occurred. Rolling back successful releases from this run."
          TAGS_TO_DELETE="${{ needs.release.outputs.created_tags }}"
          for tag in $TAGS_TO_DELETE; do
            echo "Deleting release for tag: $tag"
            gh release delete "$tag" --yes
          done
          echo "Rollback complete."
